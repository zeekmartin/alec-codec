name: Release

on:
  push:
    tags:
      - 'v*'                    # Legacy: v1.2.0 (codec only)
      - 'codec-*'               # New: codec-1.2.0
      - 'ffi-*'                 # New: ffi-1.0.0
      - 'gateway-*'             # Short: gateway-0.1.0
      - 'alec-gateway-*'        # Full: alec-gateway-v0.1.0-alpha
      - 'complexity-*'          # Short: complexity-0.1.0
      - 'alec-complexity-*'     # Full: alec-complexity-v0.1.0-alpha

env:
  CARGO_TERM_COLOR: always

jobs:
  # Parse tag to determine what to release
  prepare:
    runs-on: ubuntu-latest
    outputs:
      crate: ${{ steps.parse.outputs.crate }}
      version: ${{ steps.parse.outputs.version }}
      is_prerelease: ${{ steps.parse.outputs.is_prerelease }}
      crate_dir: ${{ steps.parse.outputs.crate_dir }}
      release_name: ${{ steps.parse.outputs.release_name }}
      package_name: ${{ steps.parse.outputs.package_name }}
    steps:
      - name: Parse tag
        id: parse
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          
          # Determine crate and version from tag format
          if [[ "$TAG" == alec-gateway-* ]]; then
            # Format: alec-gateway-v0.1.0-alpha
            CRATE="gateway"
            VERSION="${TAG#alec-gateway-}"
            VERSION="${VERSION#v}"  # Remove leading 'v' if present
            CRATE_DIR="alec-gateway"
            PACKAGE_NAME="alec-gateway"
            RELEASE_NAME="ALEC Gateway $VERSION"
            
          elif [[ "$TAG" == alec-complexity-* ]]; then
            # Format: alec-complexity-v0.1.0-alpha
            CRATE="complexity"
            VERSION="${TAG#alec-complexity-}"
            VERSION="${VERSION#v}"  # Remove leading 'v' if present
            CRATE_DIR="alec-complexity"
            PACKAGE_NAME="alec-complexity"
            RELEASE_NAME="ALEC Complexity $VERSION"
            
          elif [[ "$TAG" == gateway-* ]]; then
            # Format: gateway-0.1.0
            CRATE="gateway"
            VERSION="${TAG#gateway-}"
            CRATE_DIR="alec-gateway"
            PACKAGE_NAME="alec-gateway"
            RELEASE_NAME="ALEC Gateway $VERSION"
            
          elif [[ "$TAG" == complexity-* ]]; then
            # Format: complexity-0.1.0
            CRATE="complexity"
            VERSION="${TAG#complexity-}"
            CRATE_DIR="alec-complexity"
            PACKAGE_NAME="alec-complexity"
            RELEASE_NAME="ALEC Complexity $VERSION"
            
          elif [[ "$TAG" == ffi-* ]]; then
            # Format: ffi-1.0.0
            CRATE="ffi"
            VERSION="${TAG#ffi-}"
            CRATE_DIR="alec-ffi"
            PACKAGE_NAME="alec-ffi"
            RELEASE_NAME="ALEC FFI $VERSION"
            
          elif [[ "$TAG" == codec-* ]]; then
            # Format: codec-1.2.0
            CRATE="codec"
            VERSION="${TAG#codec-}"
            CRATE_DIR="."
            PACKAGE_NAME="alec"
            RELEASE_NAME="ALEC Codec $VERSION"
            
          elif [[ "$TAG" == v* ]]; then
            # Legacy format: v1.2.0 -> codec
            CRATE="codec"
            VERSION="${TAG#v}"
            CRATE_DIR="."
            PACKAGE_NAME="alec"
            RELEASE_NAME="ALEC $VERSION"
            
          else
            echo "âŒ Unknown tag format: $TAG"
            exit 1
          fi
          
          echo "crate=$CRATE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "crate_dir=$CRATE_DIR" >> $GITHUB_OUTPUT
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          
          # Check if prerelease (alpha, beta, rc)
          if [[ "$VERSION" == *"alpha"* ]] || [[ "$VERSION" == *"beta"* ]] || [[ "$VERSION" == *"rc"* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi
          
          echo "ðŸ“¦ Release: $RELEASE_NAME"
          echo "   Crate: $CRATE"
          echo "   Package: $PACKAGE_NAME"
          echo "   Version: $VERSION"
          echo "   Directory: $CRATE_DIR"
          echo "   Prerelease: $([[ "$VERSION" == *"alpha"* ]] || [[ "$VERSION" == *"beta"* ]] || [[ "$VERSION" == *"rc"* ]] && echo 'true' || echo 'false')"

  # Build and test
  build:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          
      - name: Build release
        run: cargo build --release
        
      - name: Run tests
        run: cargo test --release
        
      - name: Run tests with features (gateway)
        if: needs.prepare.outputs.crate == 'gateway'
        run: cargo test -p alec-gateway --features metrics --release
        
      - name: Run tests with features (complexity)
        if: needs.prepare.outputs.crate == 'complexity'
        run: |
          cargo test -p alec-complexity --release
          cargo test -p alec-complexity --features gateway --release

  # Create GitHub Release
  release:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Extract changelog
        id: changelog
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION="${{ needs.prepare.outputs.version }}"
          
          # Try to extract changelog section
          if [ -f CHANGELOG.md ]; then
            # Try with tag first, then version
            CHANGELOG=$(awk "/^## \[${TAG}\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md | head -50)
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG=$(awk "/^## \[${VERSION}\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md | head -50)
            fi
          fi
          
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="Release ${{ needs.prepare.outputs.release_name }}"
          fi
          
          echo "$CHANGELOG" > release_notes.md
          
      - name: Build release artifacts
        run: cargo build --release
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "${{ needs.prepare.outputs.release_name }}"
          body_path: release_notes.md
          prerelease: ${{ needs.prepare.outputs.is_prerelease }}
          files: |
            target/release/libalec*
            target/release/alec*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Publish to crates.io (stable releases only)
  publish:
    needs: [prepare, build, release]
    runs-on: ubuntu-latest
    if: needs.prepare.outputs.is_prerelease == 'false'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          CRATE_DIR="${{ needs.prepare.outputs.crate_dir }}"
          PACKAGE="${{ needs.prepare.outputs.package_name }}"
          
          echo "ðŸ“¦ Publishing $PACKAGE from $CRATE_DIR..."
          
          # Dry run first
          cargo publish -p "$PACKAGE" --dry-run
          
          # Publish
          cargo publish -p "$PACKAGE"
          
          echo "âœ… Published $PACKAGE to crates.io"